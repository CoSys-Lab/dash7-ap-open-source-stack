# 
# OSS-7 - An opensource implementation of the DASH7 Alliance Protocol for ultra
# lowpower wireless sensor communication
#
# Copyright 2015 University of Antwerp
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

#Add the linker script to use to the linker flags


#SET(LINKER_SCRIPT "${CMAKE_CURRENT_SOURCE_DIR}/linker/STM32L152RETx_FLASH.ld" CACHE FILEPATH "")
#SET(LINKER_FLAGS "-Xlinker -Map=.map" CACHE STRING "")
#INSERT_LINKER_FLAGS(BEFORE OBJECTS INSERT "--specs=nano.specs" "-Wl,-gc-sections" "-nostartfiles")

#SET(LINKER_FLAGS "-T mem.ld -T libs.ld -T sections.ld -nostartfiles -Xlinker -L\"${CMAKE_CURRENT_SOURCE_DIR}/linker\" -Wl,-Map=.map"  CACHE STRING "")


SET(CMAKE_C_FLAGS  "${CMAKE_C_FLAGS} -mthumb -mcpu=cortex-m3  -D__weak=__attribute__((weak)) -D__packed=__attribute__((__packed__)) -DUSE_HAL_DRIVER -Wall -fdata-sections -ffunction-sections")
SET(CMAKE_ASM_FLAGS "-mthumb -mcpu=cortex-m3 $(AS_DEFS) $(AS_INCLUDES) $(OPT) -Wall -fdata-sections -ffunction-sections")

#SET(CMAKE_EXE_LINKER_FLAGS "-T mem.ld -T libs.ld -T sections.ld -nostartfiles -Xlinker -L\"C:/Users/MaartenWeyn/Documents/git/dash7-ap-open-source-stack/stack/framework/hal/chips/stm32l152/linker\" -Wl,-Map=.map --specs=nano.specs -Wl,-gc-sections -lgcc -lc -lnosys ")
SET(LINKER_FLAGS "-mthumb -mcpu=cortex-m3 -specs=nano.specs -TSTM32L152RETx_FLASH.ld -L\"C:/Users/MaartenWeyn/Documents/git/dash7-ap-open-source-stack/stack/framework/hal/chips/stm32l152/linker\" -lc -lm -lnosys -Wl,-Map=.map,--cref -Wl,--gc-sections"   CACHE STRING "")


ENABLE_LANGUAGE(ASM)
SET_PROPERTY(SOURCE system/src/cmsis/startup_stm32l152xe.S PROPERTY LANGUAGE ASM)
INCLUDE_DIRECTORIES(
		inc
		system/include
		system/include/arm
		system/include/cmsis
		system/include
		system/include/diag
		system/include/stm32l1xx
)

##Export the 'inc' directory globally		    
EXPORT_GLOBAL_INCLUDE_DIRECTORIES(
        inc
		system/include/cmsis
		system/include/stm32l1xx
)

#Please note we include 'inc' here since for complicated cmake reasons directories exported 
#with 'GLOBAL_INCLUDE_DIRECTORIES'from chip directories are not exported to the platform directory
EXPORT_PLATFORM_INCLUDE_DIRECTORIES(
		system/include/arm
		system/include/cmsis
		system/include/stm32l1xx
)

#An object library with name '${CHIP_LIBRARY_NAME}' MUST be generated by th CMakeLists.txt file for every chip
ADD_LIBRARY (${CHIP_LIBRARY_NAME} OBJECT
        system/src/cmsis/startup_stm32l152xe.S    

		system/src/cortexm/_initialize_hardware.c
		system/src/cortexm/_reset_hardware.c
		system/src/cortexm/exception_handlers.c
		
		system/src/diag/trace_impl.c
		system/src/diag/Trace.c
		
		system/src/newlib/_cxx.cpp
		system/src/newlib/_exit.c
		system/src/newlib/_sbrk.c
		system/src/newlib/_startup.c
		system/src/newlib/_syscalls.c
		system/src/newlib/assert.c		
		    
        system/src/stm32l1xx/stm32l1xx_hal_cortex.c
        system/src/stm32l1xx/stm32l1xx_hal_dma.c
        system/src/stm32l1xx/stm32l1xx_hal_flash_ex.c
        system/src/stm32l1xx/stm32l1xx_hal_flash_ramfunc.c
        system/src/stm32l1xx/stm32l1xx_hal_flash.c
        system/src/stm32l1xx/stm32l1xx_hal_gpio.c
        system/src/stm32l1xx/stm32l1xx_hal_pwr_ex.c
        system/src/stm32l1xx/stm32l1xx_hal_pwr.c
		system/src/stm32l1xx/stm32l1xx_hal_rcc_ex.c
		system/src/stm32l1xx/stm32l1xx_hal_rcc.c
		system/src/stm32l1xx/stm32l1xx_hal_tim_ex.c
		system/src/stm32l1xx/stm32l1xx_hal_tim.c
        system/src/stm32l1xx/stm32l1xx_hal.c
		
	    stm32l152_atomic.c
        stm32l152_gpio.c
	    stm32l152_mcu.c
	    stm32l152_pins.c
	    stm32l152_system.c
	    stm32l152_timer.c
	    stm32l152_uart.c
        stm32l152_watchdog.c
        
        stm32l1xx_hal_msp.c
        stm32l1xx_it.c
        system_stm32l1xx.c
)
